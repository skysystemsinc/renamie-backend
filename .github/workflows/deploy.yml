name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to project directory
            echo "ðŸ“‚ Navigating to project directory..."
            cd /var/www/vhosts/demoprojects.co/renamie.demoprojects.co

            # Source environment and nvm (ensure Node and Yarn are available)
            echo "ðŸ”„ Loading NVM and environment..."
            source ~/.bashrc || true
            source ~/.profile || true
            source ~/.nvm/nvm.sh || true

            # Use Node.js v22 (fallback to default if not available)
            echo "ðŸ”¢ Using Node.js v22 (fallback to default if not found)..."
            nvm use 22 || nvm use node

            echo "ðŸ§© Versions:"
            echo "Node.js version: $(node --version)"
            echo "NVM version: $(nvm --version)"
            echo "----------------------------------------------"
            
            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes from main branch..."
            git pull origin main
            
            # Install dependencies
            echo "ðŸ“¦ Installing dependencies..."
            npm install
            
            # Build the project
            echo "ðŸ”¨ Building the project..."
            npm run build

            echo "ðŸ§¾ Current PM2 list:"
            pm2 list
            
            # Restart PM2 services
            echo "ðŸ”„ Restarting PM2 services..."
            pm2 restart renamie-backend --update-env
            pm2 restart renamie-worker --update-env
            
            # Save PM2 process list
            echo "ðŸ’¾ Saving PM2 process list..."
            pm2 save
            
            echo "âœ… Deployment completed!"

